require "./spec_helper"


include TDS

PRE_LOGIN_DATA = Bytes[0x00, 0x00, 0x1a, 0x00, 0x06, 0x01, 0x00, 0x20, 
0x00, 0x01, 0x02, 0x00, 0x21, 0x00, 0x0c, 0x03, 
0x00, 0x2d, 0x00, 0x04, 0x04, 0x00, 0x31, 0x00, 
0x01, 0xff, 0x09, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x4d, 0x53, 0x53, 0x51, 0x4c, 0x53, 0x65, 
0x72, 0x76, 0x65, 0x72, 0x00, 0x00, 0x00, 0x00, 
0x01, 0x00 ]


describe PreLoginRequest do

  it "writes pre login correct" do
    io = IO::Memory.new()
    PreLoginRequest.new( process_id: 1_u32).write(io)
    io.to_slice[0,io.pos].should eq PRE_LOGIN_DATA
  end

  it "reads pre login correct" do 
    io = IO::Memory.new(PRE_LOGIN_DATA)
    info = PreLoginRequest.from_io(io)
    info.force_encryption.should be_false
    info.instance.should eq "MSSQLServer"
  end
end
